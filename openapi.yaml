openapi: 3.0.3
info:
  title: Babbel API
  description: |
    HTTP API for generating audio news bulletins. Combines news stories with station-specific jingles using FFmpeg.

    ## API Design Notes

    **Pure JSON API**: Story and StationVoice creation/updates now use JSON instead of multipart/form-data
    - Story create/update: Use `POST /stories` and `PUT /stories/{id}` with JSON body
    - Audio upload: Use separate endpoint `POST /stories/{id}/audio` with binary audio data
    - StationVoice create/update: Use `POST /station-voices` and `PUT /station-voices/{id}` with JSON body
    - Jingle upload: Use separate endpoint `POST /station-voices/{id}/audio` with binary audio data
    - Metadata: Returned as native JSON object instead of escaped string

    ## Authentication

    - **Local**: Username/password with session cookies
    - **OAuth/OIDC**: Microsoft Entra ID, Google, Okta support
    - **Headless Support**: Frontend redirect flow for separate API/UI domains
    - **Auto-provisioning**: New OAuth users get 'viewer' role automatically
    - **Account lockout protection**: Failed login attempt tracking

    ## Authorization

    Role-based access control:
    - admin: Full access including user management
    - editor: Content management (stations, voices, stories, bulletins)
    - viewer: Read-only access

    ## Architecture

    Station-voice junction table:
    - Each voice has different jingles per station
    - Mix point defines when voice starts over jingle
    - Files stored as `station_{id}_voice_{id}_jingle.wav`

    ## CORS

    Cross-Origin Resource Sharing (CORS) is configurable:
    - Set `BABBEL_ALLOWED_ORIGINS` environment variable
    - Empty/unset: API-only access (no browser access)
    - Comma-separated list: Only listed origins can access from browsers
    - Credentials (cookies) are supported when origin is allowed
  version: 1.0.0
      - "Station-specific voice jingles with mix points"
      - "Local and OAuth/OIDC authentication"
      - "Role-based access control (admin, editor, viewer)"
      - "Soft delete for stories and users"
      - "FFmpeg audio processing"
      - "Pagination and filtering on all list endpoints"
      - "RESTful design for radio automation"
      - "Removed redundant /broadcasts endpoint"
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  contact:
    name: Streekomroep ZuidWest
servers:
  - url: http://localhost:8080/api/v1
    description: Development server
  - url: https://your-api-server.com/api/v1
    description: Production server (configure with your domain)

tags:
  - name: System
    description: System health and status endpoints
  - name: Authentication
    description: User authentication and session management
  - name: Stations
    description: Radio station management
  - name: Voices
    description: Voice/presenter management
  - name: Stories
    description: News story management
  - name: Audio
    description: Audio file serving
  - name: Users
    description: User account management
  - name: Bulletin
    description: Audio bulletin generation
  - name: Station-Voices
    description: Station-specific voice jingle management
  - name: Automation
    description: Public endpoints for radio automation systems (mAirList, RadioDJ, etc.)

security:
  - cookieAuth: []

paths:
  /health:
    get:
      summary: Health check endpoint
      tags:
        - System
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  service:
                    type: string
                    example: babbel-api

  /public/stations/{id}/bulletin.wav:
    get:
      summary: Get bulletin audio for radio automation
      description: |
        Public endpoint for radio automation systems to fetch the latest bulletin audio.

        **Authentication**: Requires API key via `key` query parameter.
        Configure via `BABBEL_AUTOMATION_KEY` environment variable.

        **Behavior**:
        - If `max_age > 0`: Returns cached bulletin if younger than max_age, otherwise generates new
        - If `max_age = 0`: Always generates a fresh bulletin
        - If endpoint is disabled (no API key configured): Returns 404

        **Concurrency**: Only one bulletin can be generated per station at a time.
        Concurrent requests for the same station will queue.

        **Compatible systems**: mAirList, RadioDJ, PlayoutONE, StationPlaylist, and any
        system that supports HTTP audio fetching.
      operationId: getPublicBulletin
      tags:
        - Automation
      security:
        - automationApiKey: []
      parameters:
        - name: id
          in: path
          required: true
          description: Station ID
          schema:
            type: integer
            minimum: 1
          example: 1
        - name: key
          in: query
          required: true
          description: Automation API key (configured via BABBEL_AUTOMATION_KEY)
          schema:
            type: string
          example: "your-secure-api-key"
        - name: max_age
          in: query
          required: true
          description: |
            Maximum age of cached bulletin in seconds.
            - Use `0` to always generate a fresh bulletin
            - Use `3600` for bulletins up to 1 hour old
          schema:
            type: integer
            minimum: 0
          example: 3600
      responses:
        '200':
          description: Bulletin WAV audio file
          headers:
            Content-Type:
              schema:
                type: string
                example: audio/wav
            Content-Disposition:
              schema:
                type: string
                example: 'attachment; filename="bulletin_1_20240115_143000.wav"'
            Cache-Control:
              schema:
                type: string
                example: no-store
            X-Bulletin-Cached:
              schema:
                type: string
                enum: ['true', 'false']
                description: Whether this bulletin was served from cache
          content:
            audio/wav:
              schema:
                type: string
                format: binary
        '401':
          description: Invalid or missing API key
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
              example:
                type: "https://babbel.api/problems/authentication-required"
                title: "Authentication Required"
                status: 401
                detail: "API key required"
        '404':
          description: Station not found, endpoint disabled, or no stories available
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '422':
          description: Invalid parameters
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '500':
          description: Bulletin generation failed or timed out
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'

  /auth/config:
    get:
      summary: Get authentication configuration
      description: Returns available authentication methods for the API
      tags:
        - Authentication
      security: []
      responses:
        '200':
          description: Authentication configuration
          content:
            application/json:
              schema:
                type: object
                required:
                  - methods
                properties:
                  methods:
                    type: array
                    description: Available authentication methods
                    items:
                      type: string
                      enum: [local, oidc]
                    example: ["local", "oidc"]
                  oauth_url:
                    type: string
                    description: URL to start OAuth flow (only present when OAuth is enabled)
                    example: "/api/v1/auth/oauth"

  /sessions:
    post:
      summary: Login with username and password (local authentication)
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: admin
                password:
                  type: string
                  example: password
      responses:
        '201':
          description: Session created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Login successful
          headers:
            Set-Cookie:
              schema:
                type: string
                description: Session cookie
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/oauth:
    get:
      summary: Start OAuth/OIDC authentication flow
      tags:
        - Authentication
      security: []
      description: |
        Redirects to the configured OAuth provider (Azure AD, Google, etc.).
        For headless frontends, specify `frontend_url` parameter to control where users are redirected after login.
      parameters:
        - name: frontend_url
          in: query
          required: false
          schema:
            type: string
            format: uri
          description: |
            Frontend URL to redirect to after successful authentication.
            If not provided, uses BABBEL_FRONTEND_URL environment variable.
          example: "https://your-frontend.com/dashboard"
      responses:
        '302':
          description: Redirect to OAuth provider
          headers:
            Location:
              schema:
                type: string
                description: OAuth provider authorization URL
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/oauth/callback:
    get:
      summary: OAuth callback endpoint
      tags:
        - Authentication
      security: []
      description: |
        Handles the OAuth callback from the provider and redirects to the frontend.
        This endpoint is called by the OAuth provider after user authentication.
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from OAuth provider
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: CSRF protection state
        - name: error
          in: query
          required: false
          schema:
            type: string
          description: Error from OAuth provider (if authentication failed)
      responses:
        '302':
          description: Redirect to frontend application
          headers:
            Location:
              schema:
                type: string
                description: |
                  Frontend URL with status parameters:
                  - Success: `https://frontend.com/dashboard?login=success`
                  - Error: `https://frontend.com/dashboard?error=<error_message>`
              examples:
                success:
                  value: "https://your-frontend.com/dashboard?login=success"
                error:
                  value: "https://your-frontend.com/dashboard?error=invalid_credentials"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /sessions/current:
    get:
      summary: Get current user information
      tags:
        - Authentication
      description: Returns the complete user object for the authenticated user, including full_name, email, and login statistics.
      responses:
        '200':
          description: Current user information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
    delete:
      summary: Logout and destroy session
      tags:
        - Authentication
      responses:
        '204':
          description: Session terminated successfully
        '500':
          $ref: '#/components/responses/InternalServerError'

  /stations:
    get:
      summary: List all stations
      description: |
        Returns a paginated list of radio stations with modern query parameter support.
        
        ## Search Fields
        Full-text search across:
        - `s.name` - Station name
        
        ## Filter Fields
        Available filter fields:
        - `id` - Station ID
        - `name` - Station name (supports like operator for pattern matching)
        - `max_stories_per_block` - Maximum stories per bulletin block
        - `pause_seconds` - Pause duration between stories
        - `created_at` - Creation timestamp
        - `updated_at` - Last update timestamp
        
        ## Sort Fields
        Available sort fields:
        - `id` - Station ID
        - `name` - Station name (default: ascending)
        - `max_stories_per_block` - Max stories per block
        - `pause_seconds` - Pause duration
        - `created_at` - Creation timestamp
        - `updated_at` - Last update timestamp
        
        ## Examples
        - Search by name: `?search=Radio`
        - Filter by name pattern: `?filter[name][like]=%FM%`
        - Sort by creation date: `?sort=-created_at`
        - Filter by max stories: `?filter[max_stories_per_block][gte]=5`
        - Field selection: `?fields=id,name,max_stories_per_block`
        - Complex query: `?search=Radio&filter[max_stories_per_block][gte]=5&sort=name&fields=id,name`
      tags:
        - Stations
      parameters:
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/fields'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/filter'
      responses:
        '200':
          description: List of stations with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StationsListResponse'
              examples:
                basic_list:
                  summary: Basic station list
                  value:
                    data:
                      - id: 1
                        name: "Radio Station 1"
                        max_stories_per_block: 5
                        pause_seconds: 2.0
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-01-15T10:30:00Z"
                      - id: 2
                        name: "News FM"
                        max_stories_per_block: 8
                        pause_seconds: 1.5
                        created_at: "2024-01-16T14:20:00Z"
                        updated_at: "2024-01-16T14:20:00Z"
                    total: 2
                    limit: 20
                    offset: 0
                search_example:
                  summary: Search results for "Radio"
                  value:
                    data:
                      - id: 1
                        name: "Radio Station 1"
                        max_stories_per_block: 5
                        pause_seconds: 2.0
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-01-15T10:30:00Z"
                    total: 1
                    limit: 20
                    offset: 0
                field_selection:
                  summary: Field selection (fields=id,name,max_stories_per_block)
                  value:
                    data:
                      - id: 1
                        name: "Radio Station 1"
                        max_stories_per_block: 5
                      - id: 2
                        name: "News FM"
                        max_stories_per_block: 8
                    total: 2
                    limit: 20
                    offset: 0
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      summary: Create a new station
      tags:
        - Stations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StationInput'
      responses:
        '201':
          description: Station created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    format: int64
                  message:
                    type: string
              examples:
                created_station:
                  summary: Newly created station
                  value:
                    id: 3
                    message: "Station created successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /stations/{id}:
    get:
      summary: Get station by ID
      tags:
        - Stations
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Station details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Station'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    put:
      summary: Update station
      tags:
        - Stations
      parameters:
        - $ref: '#/components/parameters/id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StationInput'
      responses:
        '200':
          description: Station updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Station'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      summary: Delete station
      tags:
        - Stations
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '204':
          description: Station deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /voices:
    get:
      summary: List all voices
      description: |
        Returns a paginated list of newsreader voices with modern query parameter support.
        
        ## Search Fields
        Full-text search across:
        - `name` - Voice name
        
        ## Filter Fields
        Available filter fields:
        - `id` - Voice ID
        - `name` - Voice name (supports like operator for pattern matching)
        - `created_at` - Creation timestamp
        
        ## Sort Fields
        Available sort fields:
        - `id` - Voice ID
        - `name` - Voice name (default: ascending)
        - `created_at` - Creation timestamp
        - `updated_at` - Last update timestamp
        
        ## Examples
        - Search by name: `?search=John`
        - Filter by name pattern: `?filter[name][like]=%Announcer%`
        - Sort by name descending: `?sort=-name`
        - Multiple filters: `?filter[id][in]=1,2,3&sort=name`
        - Field selection: `?fields=id,name,created_at`
        - Complex query: `?search=Voice&filter[id][in]=1,2,3&sort=-name&fields=id,name&limit=10`
      tags:
        - Voices
      parameters:
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/fields'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/filter'
      responses:
        '200':
          description: List of voices with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoicesListResponse'
              examples:
                basic_list:
                  summary: Basic voice list
                  value:
                    data:
                      - id: 1
                        name: "Sarah Johnson"
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-01-15T10:30:00Z"
                      - id: 2
                        name: "Mike Davis"
                        created_at: "2024-01-16T14:20:00Z"
                        updated_at: "2024-01-16T14:20:00Z"
                    total: 2
                    limit: 20
                    offset: 0
                search_example:
                  summary: Search results for "Johnson"
                  value:
                    data:
                      - id: 1
                        name: "Sarah Johnson"
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-01-15T10:30:00Z"
                    total: 1
                    limit: 20
                    offset: 0
                field_selection:
                  summary: Field selection (fields=id,name)
                  value:
                    data:
                      - id: 1
                        name: "Sarah Johnson"
                      - id: 2
                        name: "Mike Davis"
                    total: 2
                    limit: 20
                    offset: 0
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      summary: Create a new voice
      tags:
        - Voices
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 255
      responses:
        '201':
          description: Voice created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    format: int64
                  message:
                    type: string
              examples:
                created_voice:
                  summary: Newly created voice
                  value:
                    id: 3
                    message: "Voice created successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /voices/{id}:
    get:
      summary: Get voice by ID
      tags:
        - Voices
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Voice details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Voice'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    put:
      summary: Update voice
      tags:
        - Voices
      parameters:
        - $ref: '#/components/parameters/id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 255
      responses:
        '200':
          description: Voice updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Voice'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      summary: Delete voice
      tags:
        - Voices
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '204':
          description: Voice deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /stories:
    get:
      summary: List all stories
      description: |
        List stories with modern query parameter support.
        
        ## Date Filtering
        Use date range filters to find stories active on specific dates:
        - `filter[start_date][lte]=2024-06-15` - Start date before or on date
        - `filter[end_date][gte]=2024-06-15` - End date after or on date
        
        ## Weekday Filtering
        The weekdays field is a bitmask integer (0-127). Each day is a power of 2:
        - Sunday=1, Monday=2, Tuesday=4, Wednesday=8, Thursday=16, Friday=32, Saturday=64
        - Common values: 127 (all days), 62 (Mon-Fri), 65 (weekend)

        Use the `band` operator for bitwise AND filtering (returns stories where field & value != 0):
        - `filter[weekdays][band]=2` - Stories that play on Monday
        - `filter[weekdays][band]=64` - Stories that play on Saturday
        - `filter[weekdays][band]=65` - Stories that play on weekend (Sat=64 + Sun=1)

        Use exact equality for specific schedule:
        - `filter[weekdays]=62` - Stories scheduled for Mon-Fri only
        - `filter[weekdays]=127` - Stories scheduled for all days

        ## Voice Filtering
        - `filter[voice_id]=5` - Stories with specific voice
        - `filter[voice_id][ne]=null` - Stories with any voice assigned
        - `filter[voice_id][null]=true` - Stories without voice

        ## Audio Filtering
        Filter stories by audio presence using the `audio_url` field:
        - `filter[audio_url]=` - Stories WITHOUT audio (empty value)
        - `filter[audio_url][ne]=` - Stories WITH audio (not empty)

        Use cases:
        - Quality control: Find stories missing audio before publication
        - Bulk TTS: Identify stories that need text-to-speech generation
        - Dashboard: Sort by audio presence with `sort=audio_url:asc`

        ## Examples
        - Active stories on June 15, 2024: `?filter[start_date][lte]=2024-06-15&filter[end_date][gte]=2024-06-15`
        - Stories that play on Monday: `?filter[weekdays][band]=2`
        - Weekend stories with voice: `?filter[weekdays][band]=65&filter[voice_id][ne]=null`
        - Search with sorting: `?search=breaking&sort=-created_at`
      tags:
        - Stories
      parameters:
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/fields'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/trashed'
        - $ref: '#/components/parameters/filter'
      responses:
        '200':
          description: List of stories
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Story'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
              examples:
                basic_list:
                  summary: Basic story list
                  value:
                    data:
                      - id: 101
                        title: "Breaking News Update"
                        text: "This is an important news update."
                        voice_id: 1
                        voice_name: "Sarah Johnson"
                        status: "active"
                        start_date: "2024-01-20"
                        end_date: "2024-01-27"
                        weekdays: 62
                        created_at: "2024-01-20T10:00:00Z"
                        updated_at: "2024-01-20T10:00:00Z"
                        deleted_at: null
                    total: 1
                    limit: 20
                    offset: 0
                filtered_by_voice:
                  summary: Stories filtered by voice (filter[voice_id][ne]=null)
                  value:
                    data:
                      - id: 101
                        title: "Breaking News Update"
                        voice_id: 1
                        voice_name: "Sarah Johnson"
                        status: "active"
                    total: 1
                    limit: 20
                    offset: 0
                field_selection:
                  summary: Stories with field selection (fields=id,title,voice_name)
                  value:
                    data:
                      - id: 101
                        title: "Breaking News Update"
                        voice_name: "Sarah Johnson"
                    total: 1
                    limit: 20
                    offset: 0
    post:
      summary: Create a new story
      description: |
        Create a new story with JSON body. Audio file must be uploaded separately via POST /stories/{id}/audio.
      tags:
        - Stories
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StoryCreate'
            example:
              title: "Breaking News Update"
              text: "This is important news content for our listeners."
              voice_id: 1
              status: "active"
              start_date: "2024-01-20"
              end_date: "2024-01-27"
              weekdays: 62
              metadata:
                priority: "high"
                category: "breaking"
      responses:
        '201':
          description: Story created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    format: int64
                  message:
                    type: string
              examples:
                created_story:
                  summary: Newly created story
                  value:
                    id: 101
                    message: "Story created successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /stories/{id}/audio:
    get:
      summary: Download story audio file
      tags:
        - Stories
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Audio file
          content:
            audio/wav:
              schema:
                type: string
                format: binary
        '404':
          description: Story not found or no audio file
    post:
      summary: Upload story audio file
      description: |
        Upload audio file for a story. Accepts WAV or MP3 format.
        Audio duration is automatically calculated and stored.
      tags:
        - Stories
      parameters:
        - $ref: '#/components/parameters/id'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - audio
              properties:
                audio:
                  type: string
                  format: binary
                  description: Audio file (WAV, MP3, or other supported formats)
      responses:
        '200':
          description: Audio uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Audio uploaded successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /stories/{id}:
    get:
      summary: Get story by ID
      tags:
        - Stories
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Story details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Story'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    put:
      summary: Update story (full update)
      description: |
        Update story with JSON body. All fields are optional - only provided fields will be updated.
        Audio file must be uploaded separately via POST /stories/{id}/audio.
      tags:
        - Stories
      parameters:
        - $ref: '#/components/parameters/id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StoryUpdate'
            example:
              title: "Updated Breaking News"
              text: "This is the updated news content."
              voice_id: 2
              status: "active"
              weekdays: 65
              metadata:
                priority: "medium"
                updated: true
      responses:
        '200':
          description: Story updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Story'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      summary: Delete story (soft delete)
      description: |
        Performs a soft delete by setting deleted_at timestamp.
        The story will no longer appear in listings unless trashed=with is specified.
        Story data and audio files are preserved for potential restoration.
      tags:
        - Stories
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '204':
          description: Story soft deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      summary: Update story state
      description: |
        Update story status or restore soft-deleted stories. 
        This endpoint can be used to:
        - Change story status (draft, active, expired)
        - Restore a soft-deleted story by setting deleted_at to empty string
      tags:
        - Stories
      parameters:
        - $ref: '#/components/parameters/id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [draft, active, expired]
                  description: Story status
                deleted_at:
                  type: string
                  description: Set to empty string ("") to restore a soft-deleted story, or any other value to soft-delete
              example:
                updateStatus:
                  summary: Update story status
                  value:
                    status: "active"
                restoreStory:
                  summary: Restore a soft-deleted story
                  value:
                    deleted_at: ""
      responses:
        '200':
          description: Story state updated successfully (status change or restore). Returns the updated story.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Story'
        '204':
          description: Story soft-deleted successfully (when deleted_at is set to a non-empty value)
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /stories/{id}/bulletins:
    get:
      summary: Get bulletin history for a story
      description: |
        Returns all bulletins that have included this specific story with modern query parameter support.
        Ordered by most recent inclusion first by default.
        
        ## Search Fields
        Full-text search across:
        - `b.filename` - Bulletin filename
        - `s.name` - Station name
        
        ## Filter Fields
        Available filter fields:
        - `id` - Bulletin ID
        - `bulletin_id` - Bulletin ID (same as id)
        - `station_id` - Station ID
        - `filename` - Bulletin filename
        - `audio_file` - Audio filename
        - `duration_seconds` - Duration in seconds
        - `file_size` - File size in bytes
        - `story_count` - Number of stories in bulletin
        - `file_purged_at` - When audio file was cleaned up (null = file exists)
        - `created_at` - Bulletin creation timestamp
        - `station_name` - Station name (from join)
        - `story_order` - Order of story in bulletin
        - `included_at` - When story was included in bulletin

        ## Sort Fields
        Available sort fields:
        - `id` - Bulletin ID
        - `station_id` - Station ID
        - `filename` - Bulletin filename
        - `audio_file` - Audio filename
        - `duration_seconds` - Duration
        - `file_size` - File size
        - `story_count` - Number of stories
        - `file_purged_at` - File cleanup timestamp
        - `created_at` - Bulletin creation timestamp
        - `station_name` - Station name
        - `story_order` - Story order in bulletin
        - `included_at` - Inclusion timestamp (default: descending)

        ## Examples
        - Search by bulletin filename: `?search=bulletin_2024`
        - Filter by station: `?filter[station_id]=1`
        - Filter by date range: `?filter[included_at][gte]=2024-01-01`
        - Sort by story order: `?sort=story_order`
        - Field selection: `?fields=id,filename,story_order,included_at`
        - Complex query: `?search=bulletin&filter[story_order][lte]=2&sort=-included_at&fields=id,filename,story_order`
      tags:
        - Stories
      parameters:
        - $ref: '#/components/parameters/id'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/fields'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/filter'
      responses:
        '200':
          description: Story bulletin history with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryBulletinsListResponse'
              examples:
                basic_history:
                  summary: Basic bulletin history for story
                  value:
                    data:
                      - id: 150
                        station_id: 1
                        station_name: "Radio Station 1"
                        filename: "bulletin_150_20240120_140500.wav"
                        audio_url: "/bulletins/150/audio"
                        duration_seconds: 185.4
                        file_size: 2965440
                        story_count: 4
                        created_at: "2024-01-20T14:05:00Z"
                        story_order: 0
                        included_at: "2024-01-20T14:05:00Z"
                      - id: 149
                        station_id: 1
                        station_name: "Radio Station 1"
                        filename: "bulletin_149_20240120_140200.wav"
                        audio_url: "/bulletins/149/audio"
                        duration_seconds: 178.2
                        file_size: 2845568
                        story_count: 3
                        created_at: "2024-01-20T14:02:00Z"
                        story_order: 1
                        included_at: "2024-01-20T14:02:00Z"
                    total: 2
                    limit: 20
                    offset: 0
                field_selection:
                  summary: Field selection (fields=id,filename,story_order,included_at)
                  value:
                    data:
                      - id: 150
                        filename: "bulletin_150_20240120_140500.wav"
                        story_order: 0
                        included_at: "2024-01-20T14:05:00Z"
                      - id: 149
                        filename: "bulletin_149_20240120_140200.wav"
                        story_order: 1
                        included_at: "2024-01-20T14:02:00Z"
                    total: 2
                    limit: 20
                    offset: 0
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users:
    get:
      summary: List all users
      tags:
        - Users
      parameters:
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/fields'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/trashed'
        - $ref: '#/components/parameters/filter'
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
    post:
      summary: Create a new user
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    format: int64
                  message:
                    type: string
              examples:
                created_user:
                  summary: Newly created user
                  value:
                    id: 5
                    message: "User created successfully"
        '400':
          $ref: '#/components/responses/BadRequest'

  /users/{id}:
    get:
      summary: Get user by ID
      tags:
        - Users
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update user
      description: |
        Update user information. All fields are optional - only provided fields will be updated.
        Can also suspend/restore users by setting the suspended field to true/false.
      tags:
        - Users
      parameters:
        - $ref: '#/components/parameters/id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      summary: Permanently delete user
      description: |
        Permanently deletes a user account and all associated data.
        This action cannot be undone. All active sessions for the user will be terminated.
        Cannot delete the last admin user.
      tags:
        - Users
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '204':
          description: User permanently deleted
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      summary: Update user state  
      description: |
        Update user state (suspend/restore) without requiring full user data. 
        This is an alternative to using PUT /users/{id} with the suspended field.
        Use this endpoint when you only want to change suspension status without providing other user fields.
      tags:
        - Users
      parameters:
        - $ref: '#/components/parameters/id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [suspend, restore]
                  description: Action to perform on user account
              required:
                - action
              example:
                action: "suspend"
      responses:
        '200':
          description: User state updated successfully. Returns the updated user.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /bulletins:
    get:
      summary: List bulletins
      description: |
        Returns a paginated list of generated bulletins with modern query parameter support.
        
        ## Search Fields
        Full-text search across:
        - `b.filename` - Bulletin filename
        - `s.name` - Station name
        
        ## Filter Fields
        Available filter fields:
        - `id` - Bulletin ID
        - `station_id` - Station ID
        - `filename` - Bulletin filename
        - `audio_file` - Audio filename
        - `duration_seconds` - Duration in seconds
        - `file_size` - File size in bytes
        - `story_count` - Number of stories in bulletin
        - `file_purged_at` - When audio file was cleaned up (null = file exists)
        - `metadata` - JSON metadata
        - `created_at` - Creation timestamp
        - `station_name` - Station name (from join)

        ## Sort Fields
        Available sort fields:
        - `id` - Bulletin ID
        - `station_id` - Station ID
        - `filename` - Bulletin filename
        - `audio_file` - Audio filename
        - `duration_seconds` - Duration
        - `file_size` - File size
        - `story_count` - Number of stories
        - `file_purged_at` - File cleanup timestamp
        - `created_at` - Creation timestamp (default: descending)
        - `station_name` - Station name

        ## Notes
        To get story information for a bulletin, use GET /bulletins/{id}/stories after fetching the bulletin list.
        
        ## Examples
        - Search by filename: `?search=bulletin_2024`
        - Filter by station: `?filter[station_id]=1`
        - Filter by date range: `?filter[created_at][gte]=2024-01-01`
        - Sort by duration: `?sort=-duration_seconds`
        - Filter by story count: `?filter[story_count][gte]=3`
        - Field selection: `?fields=id,filename,duration_seconds,story_count,created_at`
        - Complex query: `?search=2024&filter[station_id]=1&filter[story_count][gte]=3&sort=-created_at`
      tags:
        - Bulletin
      parameters:
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/fields'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/filter'
      responses:
        '200':
          description: List of bulletins with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulletinsListResponse'
              examples:
                basic_list:
                  summary: Basic bulletin list
                  value:
                    data:
                      - id: 150
                        station_id: 1
                        station_name: "Radio Station 1"
                        filename: "bulletin_150_20240120_140500.wav"
                        audio_url: "/bulletins/150/audio"
                        duration_seconds: 185.4
                        file_size: 2965440
                        story_count: 4
                        created_at: "2024-01-20T14:05:00Z"
                      - id: 149
                        station_id: 1
                        station_name: "Radio Station 1"
                        filename: "bulletin_149_20240120_140200.wav"
                        audio_url: "/bulletins/149/audio"
                        duration_seconds: 178.2
                        file_size: 2845568
                        story_count: 3
                        created_at: "2024-01-20T14:02:00Z"
                    total: 2
                    limit: 20
                    offset: 0
                filtered_by_station:
                  summary: Bulletins filtered by station ID
                  value:
                    data:
                      - id: 150
                        station_id: 1
                        station_name: "Radio Station 1"
                        filename: "bulletin_150_20240120_140500.wav"
                        duration_seconds: 185.4
                        story_count: 4
                    total: 1
                    limit: 20
                    offset: 0
                field_selection:
                  summary: Field selection (fields=id,filename,duration_seconds,story_count)
                  value:
                    data:
                      - id: 150
                        filename: "bulletin_150_20240120_140500.wav"
                        duration_seconds: 185.4
                        story_count: 4
                      - id: 149
                        filename: "bulletin_149_20240120_140200.wav"
                        duration_seconds: 178.2
                        story_count: 3
                    total: 2
                    limit: 20
                    offset: 0
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /bulletins/{id}:
    get:
      summary: Get bulletin by ID
      description: |
        Returns a single bulletin by its ID.

        The response includes computed fields:
        - `station_name` - Name of the associated station
        - `audio_url` - URL to download the bulletin audio file
      tags:
        - Bulletin
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Bulletin details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulletinResponse'
              example:
                id: 150
                station_id: 1
                station_name: "Radio Station 1"
                filename: "bulletin_1_20240120_140500.wav"
                audio_url: "/bulletins/150/audio"
                duration_seconds: 185.4
                file_size: 2965440
                story_count: 4
                created_at: "2024-01-20T14:05:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /stations/{id}/bulletins:
    get:
      summary: List bulletins for a station
      description: |
        Returns a paginated list of bulletins generated for a specific station with modern query parameter support.
        Ordered by most recent first by default.
        
        ## Search Fields
        Full-text search across:
        - `b.filename` - Bulletin filename
        - `s.name` - Station name
        
        ## Filter Fields
        Available filter fields:
        - `id` - Bulletin ID
        - `station_id` - Station ID (automatically filtered by path parameter)
        - `filename` - Bulletin filename
        - `audio_file` - Audio filename
        - `duration_seconds` - Duration in seconds
        - `file_size` - File size in bytes
        - `story_count` - Number of stories in bulletin
        - `file_purged_at` - When audio file was cleaned up (null = file exists)
        - `created_at` - Creation timestamp
        - `station_name` - Station name (from join)

        ## Sort Fields
        Available sort fields:
        - `id` - Bulletin ID
        - `filename` - Bulletin filename
        - `audio_file` - Audio filename
        - `duration_seconds` - Duration
        - `file_size` - File size
        - `story_count` - Number of stories
        - `file_purged_at` - File cleanup timestamp
        - `created_at` - Creation timestamp (default: descending)
        - `station_name` - Station name

        ## Special Parameters
        - `latest=true` - Returns only the latest bulletin with cache headers (Last-Modified, ETag)
        - `limit=1` - Also triggers the special single-bulletin response with cache headers, equivalent to `latest=true`

        ## Notes
        To get story information for bulletins, use GET /bulletins/{id}/stories for each bulletin.
        
        ## Examples
        - Latest bulletin: `?latest=true`
        - Search by filename: `?search=bulletin_2024`
        - Filter by date range: `?filter[created_at][gte]=2024-01-01`
        - Sort by duration: `?sort=-duration_seconds`
        - Field selection: `?fields=id,filename,duration_seconds,created_at`
        - Complex query: `?search=2024&filter[story_count][gte]=3&sort=-created_at&fields=id,filename,story_count`
      tags:
        - Bulletin
      parameters:
        - $ref: '#/components/parameters/id'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/fields'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/filter'
        - name: latest
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Return only the latest bulletin for this station (equivalent to limit=1)
      responses:
        '200':
          description: List of station bulletins with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulletinsListResponse'
              examples:
                basic_list:
                  summary: Basic bulletin list for station
                  value:
                    data:
                      - id: 150
                        station_id: 1
                        station_name: "Radio Station 1"
                        filename: "bulletin_150_20240120_140500.wav"
                        audio_url: "/bulletins/150/audio"
                        duration_seconds: 185.4
                        file_size: 2965440
                        story_count: 4
                        created_at: "2024-01-20T14:05:00Z"
                      - id: 149
                        station_id: 1
                        station_name: "Radio Station 1"
                        filename: "bulletin_149_20240120_140200.wav"
                        audio_url: "/bulletins/149/audio"
                        duration_seconds: 178.2
                        file_size: 2845568
                        story_count: 3
                        created_at: "2024-01-20T14:02:00Z"
                    total: 2
                    limit: 20
                    offset: 0
                latest_bulletin:
                  summary: Latest bulletin (latest=true)
                  value:
                    data:
                      - id: 150
                        station_id: 1
                        station_name: "Radio Station 1"
                        filename: "bulletin_150_20240120_140500.wav"
                        audio_url: "/bulletins/150/audio"
                        duration_seconds: 185.4
                        file_size: 2965440
                        story_count: 4
                        created_at: "2024-01-20T14:05:00Z"
                    total: 1
                    limit: 1
                    offset: 0
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      summary: Generate news bulletin for a station
      description: |
        Generates a news bulletin for a specific station with smart caching and flexible response options.
        
        ## HTTP Headers for Control
        - `Accept: audio/wav` - Return WAV file directly instead of JSON response
        - `Cache-Control: no-cache` - Force new generation ignoring cache
        - `Cache-Control: max-age=N` - Reuse existing bulletin if created within N seconds
        
        ## Response Headers
        - `X-Cache: HIT|MISS` - Indicates if bulletin was served from cache or freshly generated
        - `Age: N` - Age of the bulletin in seconds (0 for fresh bulletins)
        
        ## Notes
        To get story information, use the separate GET /bulletins/{id}/stories endpoint after bulletin generation.
      tags:
        - Bulletin
      parameters:
        - $ref: '#/components/parameters/id'
        - name: Accept
          in: header
          required: false
          schema:
            type: string
            enum: [application/json, audio/wav]
            default: application/json
          description: Response format - use 'audio/wav' to download file directly
        - name: Cache-Control
          in: header
          required: false
          schema:
            type: string
            example: "max-age=300"
          description: |
            Cache control directives:
            - `no-cache` - Force new generation ignoring existing bulletins
            - `max-age=N` - Reuse bulletin if created within N seconds
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                date:
                  type: string
                  format: date
                  description: Date for bulletin in YYYY-MM-DD format (defaults to today)
      responses:
        '200':
          description: Bulletin generated successfully or WAV file if download=true
          headers:
            X-Cache:
              schema:
                type: string
                enum: [HIT, MISS]
              description: |
                Cache status indicator:
                - `HIT` - Bulletin served from cache (existing bulletin reused)
                - `MISS` - Bulletin freshly generated
            Age:
              schema:
                type: integer
                minimum: 0
              description: Age of the bulletin in seconds (0 for freshly generated bulletins)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    format: int64
                    description: Bulletin ID (if saved to database)
                  station_id:
                    type: integer
                    description: Station ID
                  station_name:
                    type: string
                    description: Station name
                  audio_url:
                    type: string
                    description: URL to download the audio file
                  filename:
                    type: string
                    description: Bulletin filename
                  created_at:
                    type: string
                    format: date-time
                    description: When the bulletin was created
                  duration_seconds:
                    type: number
                    format: float
                    description: Duration in seconds
                  file_size:
                    type: integer
                    format: int64
                    description: File size in bytes
                  story_count:
                    type: integer
                    description: Number of stories in the bulletin
              examples:
                fresh_bulletin:
                  summary: Newly generated bulletin
                  value:
                    id: 150
                    station_id: 1
                    station_name: "Radio Station 1"
                    audio_url: "/bulletins/150/audio"
                    filename: "bulletin_150_20240120_140500.wav"
                    created_at: "2024-01-20T14:05:00Z"
                    duration_seconds: 185.4
                    file_size: 2965440
                    story_count: 4
                cached_bulletin:
                  summary: Cached bulletin (from max_age parameter - check X-Cache header)
                  value:
                    id: 149
                    station_id: 1
                    station_name: "Radio Station 1"
                    audio_url: "/bulletins/149/audio"
                    filename: "bulletin_149_20240120_140200.wav"
                    created_at: "2024-01-20T14:02:00Z"
                    duration_seconds: 178.2
                    file_size: 2845568
                    story_count: 3
            audio/wav:
              schema:
                type: string
                format: binary
                description: WAV audio file (when download=true)
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Station not found or no stories available

  /bulletins/{id}/audio:
    get:
      summary: Download bulletin audio file
      tags:
        - Bulletin
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Audio file
          content:
            audio/wav:
              schema:
                type: string
                format: binary
        '404':
          description: Bulletin not found or no audio file

  /bulletins/{id}/stories:
    get:
      summary: List stories included in a bulletin
      description: |
        Returns a paginated list of stories that were included in a specific bulletin with modern query parameter support.
        Ordered by story appearance order (story_order) by default.
        
        ## Search Fields
        Full-text search across:
        - `st.title` - Story title
        - `s.name` - Station name
        - `b.filename` - Bulletin filename
        
        ## Filter Fields
        Available filter fields:
        - `id` - Bulletin-story relationship ID
        - `bulletin_id` - Bulletin ID (automatically filtered by path parameter)
        - `story_id` - Story ID
        - `story_order` - Order of story in bulletin
        - `created_at` - When story was added to bulletin
        - `station_id` - Station ID (from bulletin join)
        - `station_name` - Station name (from join)
        - `story_title` - Story title (from join)
        - `bulletin_filename` - Bulletin filename (from join)
        
        ## Sort Fields
        Available sort fields:
        - `id` - Relationship ID
        - `story_id` - Story ID
        - `story_order` - Story order in bulletin (default: ascending)
        - `created_at` - Addition timestamp
        - `station_name` - Station name
        - `story_title` - Story title
        - `bulletin_filename` - Bulletin filename
        
        ## Examples
        - Search by story title: `?search=breaking`
        - Filter by story order: `?filter[story_order][lte]=3`
        - Sort by story title: `?sort=story_title`
        - Field selection: `?fields=id,story_id,story_order,story_title`
        - Complex query: `?search=news&filter[story_order][lte]=5&sort=story_order&fields=id,story_title,story_order`
      tags:
        - Bulletin
      parameters:
        - $ref: '#/components/parameters/id'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/fields'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/filter'
      responses:
        '200':
          description: List of stories in the bulletin with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulletinStoriesListResponse'
              examples:
                basic_list:
                  summary: Stories in bulletin ordered by appearance
                  value:
                    data:
                      - id: 1
                        bulletin_id: 150
                        story_id: 101
                        story_order: 0
                        created_at: "2024-01-20T14:05:00Z"
                        station:
                          id: 1
                          name: "Radio Station 1"
                        story:
                          id: 101
                          title: "Breaking News Update"
                        bulletin:
                          id: 150
                          filename: "bulletin_150_20240120_140500.wav"
                      - id: 2
                        bulletin_id: 150
                        story_id: 102
                        story_order: 1
                        created_at: "2024-01-20T14:05:00Z"
                        station:
                          id: 1
                          name: "Radio Station 1"
                        story:
                          id: 102
                          title: "Weather Report"
                        bulletin:
                          id: 150
                          filename: "bulletin_150_20240120_140500.wav"
                    total: 2
                    limit: 20
                    offset: 0
                field_selection:
                  summary: Field selection (fields=id,story_order,story_title)
                  value:
                    data:
                      - id: 1
                        story_order: 0
                        story_title: "Breaking News Update"
                      - id: 2
                        story_order: 1
                        story_title: "Weather Report"
                    total: 2
                    limit: 20
                    offset: 0
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /station-voices:
    get:
      summary: List station-voice relationships
      description: |
        Returns a paginated list of station-voice relationships with modern query parameter support.
        Includes station and voice information via database joins.
        
        ## Search Fields
        Full-text search across:
        - `s.name` - Station name
        - `v.name` - Voice name
        
        ## Filter Fields
        Available filter fields:
        - `id` - Station-voice relationship ID
        - `station_id` - Station ID
        - `voice_id` - Voice ID
        - `audio_url` - Filter by audio presence (maps to audio_file column)
        - `mix_point` - Mix point in seconds
        - `created_at` - Creation timestamp
        - `updated_at` - Last update timestamp

        ## Audio Filtering
        Filter station-voices by jingle audio presence:
        - `filter[audio_url]=` - Station-voices WITHOUT jingle audio
        - `filter[audio_url][ne]=` - Station-voices WITH jingle audio

        ## Sort Fields
        Available sort fields:
        - `id` - Relationship ID (default: descending)
        - `station_id` - Station ID
        - `voice_id` - Voice ID
        - `audio_file` - Audio filename
        - `mix_point` - Mix point value
        - `created_at` - Creation timestamp
        - `updated_at` - Last update timestamp
        - `station_name` - Station name
        - `voice_name` - Voice name
        
        ## Examples
        - Search by station name: `?search=Radio`
        - Filter by station: `?filter[station_id]=1`
        - Filter by voice: `?filter[voice_id]=2`
        - Sort by station name: `?sort=station_name`
        - Field selection: `?fields=id,station_name,voice_name,mix_point`
        - Complex query: `?search=Radio&filter[station_id]=1&sort=-created_at&fields=id,station_name,voice_name`
      tags:
        - Station-Voices
      parameters:
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/fields'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/filter'
      responses:
        '200':
          description: List of station-voice relationships with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StationVoicesListResponse'
              examples:
                basic_list:
                  summary: Basic station-voice relationships
                  value:
                    data:
                      - id: 1
                        station_id: 1
                        voice_id: 1
                        station_name: "Radio Station 1"
                        voice_name: "Sarah Johnson"
                        mix_point: 2.5
                        audio_url: "/station-voices/1/audio"
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-01-15T10:30:00Z"
                      - id: 2
                        station_id: 1
                        voice_id: 2
                        station_name: "Radio Station 1"
                        voice_name: "Mike Davis"
                        mix_point: 3.0
                        audio_url: "/station-voices/2/audio"
                        created_at: "2024-01-16T14:20:00Z"
                        updated_at: "2024-01-16T14:20:00Z"
                    total: 2
                    limit: 20
                    offset: 0
                search_example:
                  summary: Search results for "Radio"
                  value:
                    data:
                      - id: 1
                        station_id: 1
                        voice_id: 1
                        station_name: "Radio Station 1"
                        voice_name: "Sarah Johnson"
                        mix_point: 2.5
                    total: 1
                    limit: 20
                    offset: 0
                field_selection:
                  summary: Field selection (fields=id,station_name,voice_name,mix_point)
                  value:
                    data:
                      - id: 1
                        station_name: "Radio Station 1"
                        voice_name: "Sarah Johnson"
                        mix_point: 2.5
                    total: 1
                    limit: 20
                    offset: 0
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      summary: Create a new station-voice relationship
      description: |
        Create station-voice relationship with JSON body. Jingle audio file must be uploaded separately via POST /station-voices/{id}/audio.
      tags:
        - Station-Voices
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StationVoiceCreate'
            example:
              station_id: 1
              voice_id: 2
              mix_point: 2.5
      responses:
        '201':
          description: Station-voice relationship created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    format: int64
                  message:
                    type: string
              examples:
                created_station_voice:
                  summary: Newly created station-voice relationship
                  value:
                    id: 1
                    message: "Station-voice relationship created successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /station-voices/{id}/audio:
    get:
      summary: Download station-voice jingle file
      tags:
        - Station-Voices
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Jingle audio file
          content:
            audio/wav:
              schema:
                type: string
                format: binary
        '404':
          description: Station-voice not found or no jingle file
    post:
      summary: Upload station-voice jingle file
      description: |
        Upload jingle audio file for a station-voice relationship. Accepts WAV or MP3 format.
      tags:
        - Station-Voices
      parameters:
        - $ref: '#/components/parameters/id'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - jingle
              properties:
                jingle:
                  type: string
                  format: binary
                  description: Jingle audio file
      responses:
        '200':
          description: Jingle uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Jingle uploaded successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /station-voices/{id}:
    get:
      summary: Get station-voice relationship by ID
      tags:
        - Station-Voices
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Station-voice relationship details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StationVoice'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      summary: Update station-voice relationship
      description: |
        Update station-voice relationship properties with JSON body. All fields are optional - only provided fields will be updated.
        When updating station_id or voice_id, the system checks for duplicate combinations.
        Jingle audio file must be uploaded separately via POST /station-voices/{id}/audio.
      tags:
        - Station-Voices
      parameters:
        - $ref: '#/components/parameters/id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StationVoiceUpdate'
            example:
              station_id: 1
              voice_id: 3
              mix_point: 3.0
      responses:
        '200':
          description: Station-voice relationship updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StationVoice'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      summary: Delete station-voice relationship
      tags:
        - Station-Voices
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '204':
          description: Station-voice relationship deleted
        '404':
          $ref: '#/components/responses/NotFound'


components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: babbel_session
      description: Session-based authentication using secure cookies
    automationApiKey:
      type: apiKey
      in: query
      name: key
      description: |
        API key for radio automation systems. Configure via BABBEL_AUTOMATION_KEY environment variable.
        The endpoint returns 404 if not configured (disabled by default).

  parameters:
    id:
      name: id
      in: path
      required: true
      schema:
        type: integer
      description: Resource ID
    limit:
      name: limit
      in: query
      schema:
        type: integer
        default: 20
        maximum: 100
      description: Maximum number of items to return
    offset:
      name: offset
      in: query
      schema:
        type: integer
        default: 0
      description: Number of items to skip
    sort:
      name: sort
      in: query
      schema:
        type: string
      description: |
        Sort order. Use field:direction format or prefix notation:
        - `name:asc` or `+name` - ascending
        - `name:desc` or `-name` - descending
        - `created_at:desc,name:asc` - multiple fields
      examples:
        single_field:
          value: "name:asc"
          summary: "Sort by name ascending"
        multiple_fields:
          value: "created_at:desc,name:asc"
          summary: "Sort by created date desc, then name asc"
        prefix_notation:
          value: "-created_at,+name"
          summary: "Sort by created date desc, then name asc (prefix notation)"
    fields:
      name: fields
      in: query
      schema:
        type: string
      description: |
        Comma-separated list of fields to include in response.
        Use dot notation for nested fields.
      examples:
        basic:
          value: "id,name,created_at"
          summary: "Return only ID, name, and created date"
        nested:
          value: "id,station.name,voice.name"
          summary: "Include nested relationship fields"
    search:
      name: search
      in: query
      schema:
        type: string
      description: |
        Search term for full-text search across relevant fields.
        Searches in names, titles, text content depending on resource.
      example: "news update"
    trashed:
      name: trashed
      in: query
      schema:
        type: string
        enum: [only, with]
      description: |
        Filter soft-deleted records:
        - (omitted) - only non-deleted records (default)
        - `only` - only soft-deleted records
        - `with` - all records including deleted
    filter:
      name: filter
      in: query
      style: deepObject
      explode: true
      schema:
        type: object
        additionalProperties:
          oneOf:
            - type: string
            - type: object
              properties:
                eq:
                  type: string
                  description: Equals
                ne:
                  type: string
                  description: Not equals
                gt:
                  type: string
                  description: Greater than
                gte:
                  type: string
                  description: Greater than or equal
                lt:
                  type: string
                  description: Less than
                lte:
                  type: string
                  description: Less than or equal
                like:
                  type: string
                  description: Pattern match (SQL LIKE)
                in:
                  type: string
                  description: Comma-separated list of values
                'null':
                  type: boolean
                  description: Is null (true) or not null (false)
                band:
                  type: integer
                  description: Bitwise AND (for bitmask fields like weekdays)
      description: |
        Advanced filtering using field-based operators.

        Basic usage: `filter[field]=value`

        Advanced operators: `filter[field][op]=value`

        Supported operators:
        - `eq` - equals (default)
        - `ne` - not equals
        - `gt`, `gte`, `lt`, `lte` - comparisons
        - `like` - pattern matching
        - `in` - comma-separated values
        - `null` - is/isn't null
        - `band` - bitwise AND (for bitmask fields, returns records where field & value != 0)

        **URL Encoding:** Bracket characters `[` and `]` must be URL-encoded as `%5B` and `%5D` when using HTTP clients like curl. Most modern HTTP libraries (axios, fetch, etc.) handle this encoding automatically.
      examples:
        basic:
          value: { "name": "Radio Station" }
          summary: "Filter by exact name match"
        comparison:
          value: { "created_at": { "gte": "2024-01-01T00:00:00Z" } }
          summary: "Filter by date range"
        pattern:
          value: { "name": { "like": "%radio%" } }
          summary: "Filter by name pattern"
        multiple:
          value: { "status": "active", "voice_id": { "null": false } }
          summary: "Multiple filter conditions"
        bitwise:
          value: { "weekdays": { "band": 2 } }
          summary: "Filter stories that play on Monday (bitwise AND)"

  schemas:
    Station:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Station ID
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Unique station name (must be unique across all stations)
          x-unique: true
        max_stories_per_block:
          type: integer
          minimum: 1
        pause_seconds:
          type: number
          format: float
          minimum: 0
          maximum: 60
          default: 2.0
          description: Pause time in seconds between messages in bulletin
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    StationInput:
      type: object
      required:
        - name
        - max_stories_per_block
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Unique station name (must be unique across all stations)
          x-unique: true
        max_stories_per_block:
          type: integer
          minimum: 1
          maximum: 50
        pause_seconds:
          type: number
          format: float
          minimum: 0
          maximum: 60
          default: 2.0
          description: Pause time in seconds between messages in bulletin

    Voice:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Voice ID
        name:
          type: string
          minLength: 1
          maxLength: 255
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    StationVoice:
      type: object
      description: Represents the relationship between a station and voice with station-specific jingle configuration
      x-unique-constraint: [station_id, voice_id]
      properties:
        id:
          type: integer
          format: int64
          description: StationVoice relationship ID
        station_id:
          type: integer
          format: int64
          description: Station ID
          x-foreign-key: stations.id
        voice_id:
          type: integer
          format: int64
          description: Voice ID
          x-foreign-key: voices.id
        audio_file:
          type: string
          description: Filename of jingle audio file (empty string if no audio uploaded)
        audio_url:
          type: string
          description: API URL to download the jingle audio file (always present, may return 404 if no file exists)
        mix_point:
          type: number
          format: float
          minimum: 0
          description: Time in seconds when voice should start over the jingle
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        station_name:
          type: string
          description: Name of the station (populated by joins)
        voice_name:
          type: string
          description: Name of the voice (populated by joins)

    StationVoiceCreate:
      type: object
      required:
        - station_id
        - voice_id
      description: |
        Station-voice relationship creation schema for JSON API.
        Jingle audio file must be uploaded separately via POST /station-voices/{id}/audio.
      properties:
        station_id:
          type: integer
          description: Station ID
        voice_id:
          type: integer
          description: Voice ID
        mix_point:
          type: number
          format: float
          minimum: 0
          maximum: 300
          default: 0.0
          description: Mix point in seconds (0-300) - when voice should start over the jingle

    StationVoiceUpdate:
      type: object
      description: |
        Station-voice relationship update schema for JSON API.
        All fields are optional - only provided fields will be updated.
        Jingle audio file must be uploaded separately via POST /station-voices/{id}/audio.
      properties:
        station_id:
          type: integer
          description: New station ID (optional)
        voice_id:
          type: integer
          description: New voice ID (optional)
        mix_point:
          type: number
          format: float
          minimum: 0
          maximum: 300
          description: Mix point in seconds (0-300)

    Story:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Story ID
        title:
          type: string
          minLength: 1
          maxLength: 500
        text:
          type: string
          minLength: 1
        voice_id:
          type: integer
          format: int64
          nullable: true
          description: Voice ID if assigned, null if no voice is assigned
          x-foreign-key: voices.id
        voice_name:
          type: string
          description: Name of the assigned voice (from JOIN query)
        audio_file:
          type: string
          description: Filename of audio file (empty string if no audio uploaded)
        audio_url:
          type: string
          description: API URL to download the audio file (always present, may return 404 if no file exists)
        duration_seconds:
          type: number
          format: float
          nullable: true
        status:
          type: string
          enum: [draft, active, expired]
        start_date:
          type: string
          format: date-time
          description: Start date and time in RFC3339 format
        end_date:
          type: string
          format: date-time
          description: End date and time in RFC3339 format
        weekdays:
          type: integer
          minimum: 0
          maximum: 127
          description: |
            Bitmask for scheduling stories on specific days of the week.
            Each day is a power of 2: Sunday=1, Monday=2, Tuesday=4, Wednesday=8, Thursday=16, Friday=32, Saturday=64.
            Common values: 127 (all days), 62 (Mon-Fri weekdays), 65 (Sat+Sun weekend), 0 (no days).
        metadata:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the story was soft-deleted

    StoryCreate:
      type: object
      required:
        - title
        - text
        - start_date
        - end_date
      description: |
        Story creation schema for JSON API.
        Audio file must be uploaded separately via POST /stories/{id}/audio.
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 500
          description: Story title
        text:
          type: string
          minLength: 1
          description: Story text content
        voice_id:
          type: integer
          nullable: true
          description: Optional voice ID. Stories without a voice will not be included in bulletin generation
        status:
          type: string
          enum: [draft, active, expired]
          default: draft
          description: Story status
        start_date:
          type: string
          format: date
          description: Start date in YYYY-MM-DD format
        end_date:
          type: string
          format: date
          description: End date in YYYY-MM-DD format
        weekdays:
          type: integer
          minimum: 0
          maximum: 127
          default: 127
          description: |
            Bitmask for scheduling stories on specific days of the week.
            Each day is a power of 2: Sunday=1, Monday=2, Tuesday=4, Wednesday=8, Thursday=16, Friday=32, Saturday=64.
            Common values: 127 (all days), 62 (Mon-Fri weekdays), 65 (Sat+Sun weekend), 0 (no days).
        metadata:
          type: object
          additionalProperties: true
          description: Optional JSON metadata object for story-specific settings
          example:
            priority: "high"
            category: "breaking"
            source: "AP"

    StoryUpdate:
      type: object
      description: |
        Story update schema for JSON API.
        All fields are optional - only provided fields will be updated.
        Audio file must be uploaded separately via POST /stories/{id}/audio.
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 500
          description: Story title
        text:
          type: string
          minLength: 1
          description: Story text content
        voice_id:
          type: integer
          nullable: true
          description: Optional voice ID. Stories without a voice will not be included in bulletin generation
        status:
          type: string
          enum: [draft, active, expired]
          description: Story status
        start_date:
          type: string
          format: date
          description: Start date in YYYY-MM-DD format
        end_date:
          type: string
          format: date
          description: End date in YYYY-MM-DD format
        weekdays:
          type: integer
          minimum: 0
          maximum: 127
          description: |
            Bitmask for scheduling stories on specific days of the week.
            Each day is a power of 2: Sunday=1, Monday=2, Tuesday=4, Wednesday=8, Thursday=16, Friday=32, Saturday=64.
            Common values: 127 (all days), 62 (Mon-Fri weekdays), 65 (Sat+Sun weekend), 0 (no days).
        metadata:
          type: object
          additionalProperties: true
          description: Optional JSON metadata object for story-specific settings
          example:
            priority: "medium"
            updated: true

    User:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: User ID
        username:
          type: string
        full_name:
          type: string
        email:
          type: string
          format: email
          maxLength: 255
          nullable: true
        role:
          type: string
          enum: [admin, editor, viewer]
          description: |
            User roles:
            - admin: Full access to all resources
            - editor: Can manage content (stations, voices, stories)
            - viewer: Read-only access
        suspended_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the user was suspended
        last_login_at:
          type: string
          format: date-time
          nullable: true
        login_count:
          type: integer
        locked_until:
          type: string
          format: date-time
          nullable: true
          description: Timestamp until when the account is locked due to failed login attempts
        password_changed_at:
          type: string
          format: date-time
          nullable: true
        metadata:
          type: object
          additionalProperties: true
          description: JSON metadata object for user-specific settings
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
          nullable: true
          description: Soft delete timestamp (present when querying with ?trashed=only or ?trashed=with)

    UserInput:
      type: object
      required:
        - username
        - full_name
        - password
        - role
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 100
          pattern: '^[a-zA-Z0-9]+$'
          description: Unique username (alphanumeric only)
          x-unique: true
        full_name:
          type: string
          minLength: 1
          maxLength: 255
        password:
          type: string
          writeOnly: true
          minLength: 8
          maxLength: 128
          description: User password
        email:
          type: string
          format: email
          maxLength: 255
          nullable: true
        role:
          type: string
          enum: [admin, editor, viewer]
          description: |
            User roles and permissions:
            - admin: Full access to all resources including user management
            - editor: Can manage content (stations, voices, stories, bulletins)
            - viewer: Read-only access to content
        metadata:
          type: object
          additionalProperties: true
          description: JSON metadata object for user-specific settings (optional)
        suspended:
          type: boolean
          description: Set to true to suspend user, false to restore (optional, only for PUT /users/{id})

    BulletinResponse:
      type: object
      description: Bulletin with additional API response fields
      properties:
        id:
          type: integer
          format: int64
          description: Bulletin ID
        station_id:
          type: integer
          format: int64
          description: Station ID
          x-foreign-key: stations.id
        station_name:
          type: string
          description: Name of the station
        audio_url:
          type: string
          description: URL to download the audio file
        filename:
          type: string
          description: Filename of the bulletin audio file
        created_at:
          type: string
          format: date-time
        duration_seconds:
          type: number
          format: float
          description: Duration of the bulletin in seconds
        file_size:
          type: integer
          format: int64
          description: Size of the audio file in bytes
        story_count:
          type: integer
          description: Number of stories included in the bulletin
        file_purged_at:
          type: string
          format: date-time
          nullable: true
          description: When the audio file was cleaned up (null means file still exists)

    ProblemDetails:
      type: object
      description: |
        RFC 9457 Problem Details for HTTP APIs.

        ## Problem Types

        Generic problem type URIs (fixed):
        - `https://babbel.api/problems/validation-error` - 422 request body validation errors
        - `https://babbel.api/problems/resource-not-found` - 404 resource not found (generic)
        - `https://babbel.api/problems/bad-request` - 400 malformed request
        - `https://babbel.api/problems/authentication-required` - 401 authentication required
        - `https://babbel.api/problems/insufficient-permissions` - 403 insufficient permissions
        - `https://babbel.api/problems/admin-constraint` - 409 cannot delete last admin user
        - `https://babbel.api/problems/internal-server-error` - 500 internal server error

        Resource-specific problem type URIs follow the pattern
        `https://babbel.api/problems/{resource}.{error_type}` where the `code` field
        contains the `{resource}.{error_type}` value. Examples:
        - `{resource}.not_found` - 404 typed resource not found
        - `{resource}.duplicate` - 409 unique constraint violation
        - `{resource}.has_dependencies` - 409 cannot delete, has dependent resources
        - `{resource}.validation_failed` - 400 field-level validation error
        - `bulletin.no_stories` - 422 no active stories for bulletin generation
        - `audio.processing_failed` - 500 FFmpeg processing error
        - `internal.database_error` - 500 unexpected database error
        - `internal.timeout` - 500 operation timed out
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: URI that identifies the problem type
          example: "https://babbel.api/problems/validation-error"
        title:
          type: string
          description: Short, human-readable summary of the problem
          example: "Validation Error"
        status:
          type: integer
          description: HTTP status code
          example: 422
        detail:
          type: string
          description: Human-readable explanation specific to this occurrence
          example: "The request body contains invalid data"
        instance:
          type: string
          format: uri
          description: URI that identifies the specific occurrence of the problem
          example: "/api/v1/stories/123"
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the error occurred
          example: "2024-01-20T14:05:00Z"
        code:
          type: string
          description: Machine-readable error code in "resource.error" format
          example: "station.not_found"
        hint:
          type: string
          description: User-friendly suggestion for resolving the error
          example: "Check the resource ID and try again"
        trace_id:
          type: string
          description: Optional trace ID for debugging
          example: "abc123def456"
        errors:
          type: array
          description: Array of validation errors (for 422 responses)
          items:
            type: object
            properties:
              field:
                type: string
                description: Field name that failed validation
                example: "title"
              message:
                type: string
                description: Human-readable error message
                example: "Title is required"

    ValidationError:
      allOf:
        - $ref: '#/components/schemas/ProblemDetails'
        - type: object
          properties:
            type:
              example: "https://babbel.api/problems/validation-error"
            title:
              example: "Validation Error"
            status:
              example: 422

    ConflictError:
      allOf:
        - $ref: '#/components/schemas/ProblemDetails'
        - type: object
          properties:
            type:
              example: "https://babbel.api/problems/duplicate"
            title:
              example: "Resource Conflict"
            status:
              example: 409

    # Paginated Response Schemas for Modern CRUD Endpoints
    StationsListResponse:
      type: object
      description: Paginated response for stations list endpoint
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Station'
        total:
          type: integer
          description: Total number of stations matching the query
        limit:
          type: integer
          description: Maximum number of items per page
        offset:
          type: integer
          description: Number of items skipped for pagination

    VoicesListResponse:
      type: object
      description: Paginated response for voices list endpoint
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Voice'
        total:
          type: integer
          description: Total number of voices matching the query
        limit:
          type: integer
          description: Maximum number of items per page
        offset:
          type: integer
          description: Number of items skipped for pagination

    StationVoicesListResponse:
      type: object
      description: Paginated response for station-voices list endpoint
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/StationVoice'
        total:
          type: integer
          description: Total number of station-voice relationships matching the query
        limit:
          type: integer
          description: Maximum number of items per page
        offset:
          type: integer
          description: Number of items skipped for pagination

    BulletinsListResponse:
      type: object
      description: Paginated response for bulletins list endpoints
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/BulletinResponse'
        total:
          type: integer
          description: Total number of bulletins matching the query
        limit:
          type: integer
          description: Maximum number of items per page
        offset:
          type: integer
          description: Number of items skipped for pagination

    BulletinStoriesListResponse:
      type: object
      description: |
        Paginated response for bulletin stories list endpoint.

        **Note:** The current implementation returns only the basic relationship fields.
        Nested objects (station, story, bulletin) shown in examples are NOT currently
        included in the actual API response. Use the individual resource endpoints
        to fetch full details for stations, stories, or bulletins.
      properties:
        data:
          type: array
          items:
            type: object
            description: Bulletin-story relationship (basic fields only)
            properties:
              id:
                type: integer
                description: Bulletin-story relationship ID
              bulletin_id:
                type: integer
                description: Bulletin ID
              story_id:
                type: integer
                description: Story ID
              story_order:
                type: integer
                description: Order of story in bulletin
              created_at:
                type: string
                format: date-time
                description: When story was added to bulletin
              # NOTE: The following nested objects are documented for future implementation
              # but are NOT currently returned by the API
              station:
                type: object
                description: "NOT CURRENTLY IMPLEMENTED - Use GET /stations/{id} instead"
                x-not-implemented: true
                properties:
                  id:
                    type: integer
                    description: Station ID
                  name:
                    type: string
                    description: Station name
              story:
                type: object
                description: "NOT CURRENTLY IMPLEMENTED - Use GET /stories/{id} instead"
                x-not-implemented: true
                properties:
                  id:
                    type: integer
                    description: Story ID
                  title:
                    type: string
                    description: Story title
              bulletin:
                type: object
                description: "NOT CURRENTLY IMPLEMENTED - Use GET /bulletins/{id} instead"
                x-not-implemented: true
                properties:
                  id:
                    type: integer
                    description: Bulletin ID
                  filename:
                    type: string
                    description: Bulletin filename
        total:
          type: integer
          description: Total number of story-bulletin relationships matching the query
        limit:
          type: integer
          description: Maximum number of items per page
        offset:
          type: integer
          description: Number of items skipped for pagination

    StoryBulletinsListResponse:
      type: object
      description: |
        Paginated response for story bulletins history endpoint.

        **Note:** The `story_order` and `included_at` fields shown below are planned
        but NOT currently returned by the API. The current implementation returns
        only the standard BulletinResponse fields.
      properties:
        data:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/BulletinResponse'
              - type: object
                properties:
                  story_order:
                    type: integer
                    description: |
                      Order of story in this bulletin.
                      **NOT CURRENTLY IMPLEMENTED** - Planned for future release.
                    x-not-implemented: true
                  included_at:
                    type: string
                    format: date-time
                    description: |
                      When story was included in this bulletin.
                      **NOT CURRENTLY IMPLEMENTED** - Planned for future release.
                    x-not-implemented: true
        total:
          type: integer
          description: Total number of bulletins that included this story
        limit:
          type: integer
          description: Maximum number of items per page
        offset:
          type: integer
          description: Number of items skipped for pagination

  responses:
    BadRequest:
      description: Bad request
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Unauthorized:
      description: Unauthorized
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Forbidden:
      description: Insufficient permissions
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          examples:
            insufficient_permissions:
              summary: User lacks required permission
              value:
                type: "https://babbel.api/problems/forbidden"
                title: "Insufficient Permissions"
                status: 403
                detail: "You do not have permission to perform this action"
                instance: "/api/v1/users"
    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Conflict:
      description: |
        Resource conflict (duplicate, constraint violation).

        Common problem types for 409 responses:
        - `https://babbel.api/problems/duplicate` - Duplicate resource (e.g., station name already exists)
        - `https://babbel.api/problems/dependency-constraint` - Resource has dependencies that prevent deletion
        - `https://babbel.api/problems/admin-constraint` - Cannot delete last admin user
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ConflictError'
          examples:
            duplicate_name:
              summary: Duplicate station name
              value:
                type: "https://babbel.api/problems/duplicate"
                title: "Resource Conflict"
                status: 409
                detail: "A station with this name already exists"
                instance: "/api/v1/stations"
            dependency_constraint:
              summary: Resource has dependencies
              value:
                type: "https://babbel.api/problems/dependency-constraint"
                title: "Dependency Constraint"
                status: 409
                detail: "Cannot delete station with existing bulletins"
                instance: "/api/v1/stations/1"
            admin_constraint:
              summary: Cannot delete last admin
              value:
                type: "https://babbel.api/problems/admin-constraint"
                title: "Admin Constraint"
                status: 409
                detail: "Cannot delete the last admin user"
                instance: "/api/v1/users/1"
    UnprocessableEntity:
      description: Validation error
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          examples:
            validation_errors:
              summary: Field validation errors
              value:
                type: "https://babbel.api/problems/validation-error"
                title: "Validation Error"
                status: 422
                detail: "The request contains validation errors"
                instance: "/api/v1/stations"
                errors:
                  - field: "name"
                    message: "Name is required"
                  - field: "max_stories_per_block"
                    message: "Must be between 1 and 50"
            data_too_long:
              summary: Data exceeds maximum length
              value:
                type: "https://babbel.api/problems/data-too-long"
                title: "Data Too Long"
                status: 422
                detail: "Data exceeds maximum length"
                instance: "/api/v1/stories"
                errors:
                  - field: "title"
                    message: "Title exceeds maximum length of 500 characters"
            no_stories:
              summary: No stories available for bulletin generation
              value:
                type: "https://babbel.api/problems/no-stories"
                title: "No Stories Available"
                status: 422
                detail: "No stories available for bulletin generation"
                instance: "/api/v1/stations/1/bulletins"
    InternalServerError:
      description: Internal server error
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
